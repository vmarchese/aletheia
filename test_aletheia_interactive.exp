#!/usr/bin/expect -f

set timeout 300
log_user 1

# Disable terminal warnings
set env(TERM) "xterm"

# Start the aletheia session
spawn bash -c "source .venv/bin/activate && uv run --env-file .env aletheia/cli.py session open --very-verbose --unsafe"

# Wait for session to be ready - look for "Session ID:"
expect {
    -re "Session ID:" {
        puts "\n\n=== Session created, waiting for prompt ===\n"
        sleep 5
    }
    timeout {
        puts "Timeout waiting for session to start"
        exit 1
    }
}

# Send first query
puts "\n>>> Sending query 1: puoi estrarmi la lista dei bucket s3\n"
send "puoi estrarmi la lista dei bucket s3\r"

# Wait for response - use a long timeout and look for the usage stats line
expect {
    -re "Usage:.*In:.*Out:" {
        puts "\n\n=== Response 1 complete ===\n"
        sleep 5
    }
    timeout {
        puts "\nTimeout waiting for response to query 1, continuing anyway\n"
    }
}

# Send second query
puts "\n>>> Sending query 2: quali bucket sono su milano\n"
send "quali bucket sono su milano\r"

# Wait for response
expect {
    -re "Usage:.*In:.*Out:" {
        puts "\n\n=== Response 2 complete ===\n"
        sleep 5
    }
    timeout {
        puts "\nTimeout waiting for response to query 2, continuing anyway\n"
    }
}

# Send third query
puts "\n>>> Sending query 3: quale è lo stato dei miei pod\n"
send "quale è lo stato dei miei pod\r"

# Wait for response
expect {
    -re "Usage:.*In:.*Out:" {
        puts "\n\n=== Response 3 complete ===\n"
        sleep 5
    }
    timeout {
        puts "\nTimeout waiting for response to query 3, continuing anyway\n"
    }
}

# Exit
puts "\n>>> Sending exit command\n"
send "exit\r"

# Wait for clean exit
expect {
    eof {
        puts "\n=== Session closed successfully ===\n"
    }
    timeout {
        puts "\n=== Timeout waiting for exit ===\n"
    }
}
